{"version":3,"sources":["../../routes/smsru.js"],"names":["randomstring","require","SMSru","sms","router","Router","post","req","res","login","body","generate","length","charset","code","findOne","err","userx","json","sms_send","to","text","e","console","log","description","smscount","checkcode","save","success","status","message","password","confirmed"],"mappings":"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","file":"smsru.js","sourcesContent":["/**\r\n * Created by Semyon on 31.03.2017.\r\n */\r\nimport express from 'express';\r\nimport User from '../models/user';\r\nvar randomstring = require(\"randomstring\");\r\nvar SMSru = require('sms_ru');\r\nvar sms = new SMSru('AA0C7A43-90D1-284B-C28E-CD6C22088350');\r\nconst router = express.Router();\r\nrouter.post('/smssend', async function (req, res) {\r\n    const login = req.body.login;\r\n    const code = await randomstring.generate({\r\n        length: 5,\r\n        charset: 'numeric'\r\n    });\r\n    User.findOne({login: login}, async function (err, userx) {\r\n        if (err) {\r\n            res.json('User not found');\r\n        }\r\n        else {\r\n            sms.sms_send({\r\n                to: login,\r\n                text: code\r\n            }, function (e) {\r\n                console.log(e.description);\r\n            });\r\n            if (userx.smscount !== null) {\r\n                if (userx.smscount < 15) {\r\n                    userx.smscount++;\r\n                    userx.checkcode = code;\r\n                    console.log(code);\r\n                    userx.save();\r\n                    res.json({\r\n                        success: true,\r\n                        status: 200,\r\n                        message: 'sms was successfully sended'\r\n                    });\r\n                }\r\n                else {\r\n                    res.json({\r\n                        success: false,\r\n                        status: 400,\r\n                        message: 'You exceeded the sms-limit'\r\n                    });\r\n                }\r\n            }else {\r\n                    userx.checkcode = code;\r\n                    console.log(code);\r\n                    userx.save();\r\n                    res.json({\r\n                        success: true,\r\n                        status: 200,\r\n                        message: 'sms was successfully sended'\r\n                    });\r\n\r\n            }\r\n\r\n        }\r\n    });\r\n});\r\nrouter.post('/checksms', async function (req, res) {\r\n    const login = req.body.login;\r\n    User.findOne({login: login}, async function (err, userx) {\r\n        if (err) {\r\n            res.json({\r\n                success: false,\r\n                status: 400,\r\n                message: 'user not found'\r\n            });\r\n        }\r\n        else {\r\n            if (userx.checkcode === req.body.checkcode) {\r\n                if (req.body.password) {\r\n                    userx.password = req.body.password;\r\n                    userx.save();\r\n                    res.json({\r\n                        success: true,\r\n                        message: 'password changed'\r\n                    })\r\n                } else {\r\n                    userx.confirmed = 1;\r\n                    userx.save();\r\n                    res.json({\r\n                        success: true,\r\n                        message: 'account was confirmed'\r\n                    });\r\n                }\r\n            }\r\n            else {\r\n                res.json({\r\n                    success: false,\r\n                    status: 400,\r\n                    message: 'wrong checkcode'\r\n                });\r\n            }\r\n        }\r\n    });\r\n});\r\n\r\n/*\r\n res.json(user);\r\n }else{\r\n doc.user('login','12312312');\r\n User.save();\r\n res.json(user);}\r\n });*/\r\n\r\nexport default router;"]}